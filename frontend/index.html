<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CRUD End-to-End — Entities</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 0 10px; }
    .card { border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; border-radius: 6px; }
    label { display:block; margin-top:8px; }
    input, textarea, select { width:100%; padding:8px; box-sizing:border-box; }
    button { margin-top:8px; }
    .actions button { margin-right:6px; }
  </style>
</head>
<body>
  <h1>Entities (CRUD)</h1>

  <section class="card">
    <h3 id="formTitle">Dodaj nową encję</h3>
    <form id="entityForm">
      <input type="hidden" id="entityId" value="">
      <label>Imię (name)
        <input id="name" required>
      </label>
      <label>Typ (type)
        <input id="type" required>
      </label>
      <label>Opis
        <textarea id="description"></textarea>
      </label>
      <label>Extra (extra_text)
        <input id="extra_text">
      </label>
      <button type="submit">Zapisz</button>
      <button type="button" id="cancelEdit" style="display:none;">Anuluj</button>
    </form>
  </section>

  <section>
    <h2>Lista</h2>
    <div id="list"></div>
  </section>

  <template id="itemTpl">
    <div class="card">
      <strong class="title"></strong> <em class="type"></em>
      <p class="description"></p>
      <div class="actions">
        <button class="btnView">Szczegóły</button>
        <button class="btnEdit">Edytuj</button>
        <button class="btnDelete">Usuń</button>
      </div>
    </div>
  </template>

<script>
    const apiBase = 'https://crud-ckk0.onrender.com';

async function fetchList() {
  const res = await fetch(apiBase);
  const data = await res.json();
  const list = document.getElementById('list');
  list.innerHTML = '';
  data.forEach(item => {
    const tpl = document.getElementById('itemTpl').content.cloneNode(true);
    tpl.querySelector('.title').textContent = item.name + ' (id:' + item.id + ')';
    tpl.querySelector('.type').textContent = item.type;
    tpl.querySelector('.description').textContent = item.description || '';
    tpl.querySelector('.btnView').onclick = () => alert(JSON.stringify(item, null, 2));
    tpl.querySelector('.btnEdit').onclick = () => startEdit(item);
    tpl.querySelector('.btnDelete').onclick = () => doDelete(item.id);
    list.appendChild(tpl);
  });
}

function startEdit(item) {
  document.getElementById('formTitle').textContent = 'Edytuj encję #' + item.id;
  document.getElementById('entityId').value = item.id;
  document.getElementById('name').value = item.name;
  document.getElementById('type').value = item.type;
  document.getElementById('description').value = item.description || '';
  document.getElementById('extra_text').value = item.extra_text || '';
  document.getElementById('cancelEdit').style.display = 'inline-block';
}

document.getElementById('cancelEdit').onclick = () => {
  resetForm();
};

function resetForm() {
  document.getElementById('formTitle').textContent = 'Dodaj nową encję';
  document.getElementById('entityId').value = '';
  document.getElementById('entityForm').reset();
  document.getElementById('cancelEdit').style.display = 'none';
}

async function doDelete(id) {
  if (!confirm('Usunąć encję #' + id + '?')) return;
  const res = await fetch(apiBase + '/' + id, { method: 'DELETE' });
  if (res.status === 204) {
    fetchList();
  } else {
    alert('Błąd usuwania');
  }
}

document.getElementById('entityForm').onsubmit = async (e) => {
  e.preventDefault();
  const id = document.getElementById('entityId').value;
  const payload = {
    name: document.getElementById('name').value.trim(),
    type: document.getElementById('type').value.trim(),
    description: document.getElementById('description').value.trim(),
    extra_text: document.getElementById('extra_text').value.trim()
  };
  if (!payload.name || !payload.type) {
    alert('Wypełnij wymagane pola');
    return;
  }

  if (id) {
    const res = await fetch(apiBase + '/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      resetForm();
      fetchList();
    } else {
      const err = await res.json();
      alert('Błąd: ' + JSON.stringify(err));
    }
  } else {
    const res = await fetch(apiBase, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.status === 201) {
      resetForm();
      fetchList();
    } else {
      const err = await res.json();
      alert('Błąd: ' + JSON.stringify(err));
    }
  }
};

fetchList();
</script>
</body>
</html>
